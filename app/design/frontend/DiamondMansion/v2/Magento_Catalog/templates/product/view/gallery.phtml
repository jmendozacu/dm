<?php 
$jsonGallery =  $block->getGalleryImagesJson();
$arrayJsonGallery = json_decode($jsonGallery, true);
$isVideoExist = false;
?>
<div class="gallery-placeholder product-image">
    <div id="gallery">
        <?php $index = 0; foreach ($arrayJsonGallery as $_image): ?>
        <?php if ($_image['type'] == 'video'): ?>
        <?php
            if (strpos($_image['videoUrl'], 'watch?v=') !== false) {
                $videoUrlParams = explode('watch?v=', $_image['videoUrl']);
                $_image['videoUrl'] = 'https://www.youtube.com/embed/' . $videoUrlParams[1] . '?controls=0';
            }
        ?>
        <li>
            <div class="video-wrapper">
                <iframe src="<?= $_image['videoUrl'] ?>&enablejsapi=1" width="100%"></iframe>
            </div>
        </li>
        <?php else: ?>
        <li>
            <a class="cloud-zoom-gallery" 
                data-zoom='"useZoom":"zoom", "smallImage":"<?php echo str_replace('\\', '/', $_image['img']); ?>"' 
                href="<?php echo $_image['full']; ?>" 
                title="<?php echo $_image['caption'] ?>">
                <img <?php echo ($index == 0) ? 'src' : 'data-lazy' ?>="<?php echo $_image['full']; ?>" alt="<?php echo $_image['caption'] ?>"/>
            </a>
        </li>
        <?php endif ?>
        <?php $index ++; endforeach ?>
    </div>
    <div class="gallery-thumbnail desktop">
        <?php $index = 0; foreach ($arrayJsonGallery as $_image): ?>
        <?php if ($_image['type'] == 'video'): ?>
        <?php
            if (strpos($_image['videoUrl'], 'watch?v=') !== false) {
                $videoUrlParams = explode('watch?v=', $_image['videoUrl']);
                $_image['videoUrl'] = 'https://www.youtube.com/embed/' . $videoUrlParams[1] . '?controls=0';
            }
        ?>
        <li <?php echo ($index == 0) ? 'class="selected"' : '' ?>>
            <div class="video-wrapper">
                <iframe src="<?= $_image['videoUrl'] ?>" width="80px" height="80px"></iframe>
            </div>
        </li>
        <?php else: ?>
        <li <?php echo ($index == 0) ? 'class="selected"' : '' ?>>
            <img src="<?php echo $_image['full']; ?>" alt="<?php echo $_image['caption'] ?>"/>
        </li>
        <?php endif ?>
        <?php $index ++; endforeach ?>
    </div>
</div>
<script type="text/javascript">
require([
    'jquery',
    'slick',
    'cloudzoom'
], function ($) {
    $(document).ready(function () {

        $('#gallery').slick({
            dots: true,
            infinite: false,
            slidesToShow: 1,
            slidesToScroll: 1,
            responsive: [
                {
                    breakpoint: 1280,
                    settings: {
                        slidesToShow: 1,
                        slidesToScroll: 1
                    }
                }
            ]
        });

        $('#gallery').on('beforeChange', function (event, slick, currentSlide, nextSlide) {
            var mySlideNumber = nextSlide;
            $('.gallery-thumbnail li.selected').removeClass('selected');
            $('.gallery-thumbnail li').eq(mySlideNumber).addClass('selected');
        });        

        $('#gallery iframe').height($('#gallery iframe').width());

        $('.gallery-thumbnail li').on('click', function () {
            event.stopPropagation();

            $('.gallery-thumbnail li.selected').removeClass('selected');
            $(this).addClass('selected');

            $('#gallery').slick('slickGoTo', $(this).index());
        });

        $('#gallery .video-wrapper').on('click', function () {
            var $video = $(this).find('iframe');
            if ($video.hasClass('playing')) {
                $video[0].contentWindow.postMessage('{"event":"command","func":"' + 'stopVideo' + '","args":""}', '*');    
                $video.removeClass('playing');
            } else {
                $video[0].contentWindow.postMessage('{"event":"command","func":"' + 'playVideo' + '","args":""}', '*');
                $video.addClass('playing');
            }
        });


        if ($('#zoom').length) {
            $('.cloud-zoom, .cloud-zoom-gallery').CloudZoom();
        }
    });
});
</script>